---
version: '3'

tasks:
  default:
    desc: 'Show available tasks'
    cmds:
      - task --list

  install:generator:
    desc: 'Install the generator tool'
    cmds:
      - go install github.com/inference-gateway/tools/cmd/generator@v0.1.1

  a2a:download-schema:
    desc: 'Download the latest A2A schema and convert to YAML'
    cmds:
      - curl -o schema.yaml https://raw.githubusercontent.com/inference-gateway/schemas/refs/heads/main/a2a/a2a-schema.yaml

  a2a:generate-types:
    desc: 'Generate the Golang ADK types from the A2A schema'
    deps:
      - install:generator
    cmds:
      - generator -generator jsonrpc -package adk schema.yaml adk/generated_types.go

  tidy:
    desc: 'Tidy all Go modules'
    cmds:
      - find . -name 'go.mod' -execdir go mod tidy \;

  lint:
    desc: 'Run Go static analysis and linting'
    cmds:
      - golangci-lint run

  build:
    desc: 'Build the Go application'
    cmds:
      - go build -o bin/app .

  test:
    desc: 'Run tests'
    cmds:
      - go test -v ./...

  clean:
    desc: 'Clean up'
    cmds:
      - rm -rf bin

  clean:mocks:
    desc: 'Clean up generated mocks'
    cmds:
      - rm -rf adk/server/mocks/*.go

  generate:mocks:
    desc: 'Generate all mocks using counterfeiter'
    cmds:
      - task: generate:mock:a2a-server
      - task: generate:mock:task-handler
      - task: generate:mock:message-handler
      - task: generate:mock:task-manager
      - task: generate:mock:a2a-request-handler
      - task: generate:mock:response-sender
      - task: generate:mock:http-server
      - task: generate:mock:oidc-authenticator
      - task: generate:mock:tools-provider
      - task: generate:mock:task-result-processor
      - task: generate:mock:agent-info-provider

  generate:mocks:clean:
    desc: 'Clean and regenerate all mocks'
    cmds:
      - task: clean:mocks
      - task: generate:mocks

  generate:mock:a2a-server:
    desc: 'Generate mock for A2AServer interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_a2a_server.go adk/server A2AServer

  generate:mock:task-handler:
    desc: 'Generate mock for TaskHandler interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_task_handler.go adk/server TaskHandler

  generate:mock:message-handler:
    desc: 'Generate mock for MessageHandler interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_message_handler.go adk/server MessageHandler

  generate:mock:task-manager:
    desc: 'Generate mock for TaskManager interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_task_manager.go adk/server TaskManager

  generate:mock:a2a-request-handler:
    desc: 'Generate mock for A2ARequestHandler interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_a2a_request_handler.go adk/server A2ARequestHandler

  generate:mock:response-sender:
    desc: 'Generate mock for ResponseSender interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_response_sender.go adk/server ResponseSender

  generate:mock:http-server:
    desc: 'Generate mock for HTTPServer interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_http_server.go adk/server HTTPServer

  generate:mock:oidc-authenticator:
    desc: 'Generate mock for OIDCAuthenticator interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_oidc_authenticator.go adk/server OIDCAuthenticator

  generate:mock:tools-provider:
    desc: 'Generate mock for ToolsProvider interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_tools_provider.go adk/server ToolsProvider

  generate:mock:task-result-processor:
    desc: 'Generate mock for TaskResultProcessor interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_task_result_processor.go adk/server TaskResultProcessor

  generate:mock:agent-info-provider:
    desc: 'Generate mock for AgentInfoProvider interface'
    cmds:
      - go run github.com/maxbrunsfeld/counterfeiter/v6 -o adk/server/mocks/fake_agent_info_provider.go adk/server AgentInfoProvider
